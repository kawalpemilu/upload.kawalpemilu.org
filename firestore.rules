service cloud.firestore {
  match /databases/{database}/documents {
    function getUserRole() {
      return get(/databases/$(database)/documents/r/$(request.auth.uid))
                .data.profile.role;
    }

    // Static herarchy for searching.
    match /h/{userId} {
      allow list: if request.auth.uid != null && request.query.limit <= 10;
    }
 
    // Relawan database.
    match /r/{userId} {
      // Moderator can read user profile if know the uid.
      allow get: if request.auth.uid == userId || getUserRole() >= 1;

      // Only Admin can perform search for user profile.
      allow list: if request.query.limit <= 10 && getUserRole() >= 2;
    }
 
    // Relawan photos.
    match /p/{userId} {
      // Moderator can read user photos if know the uid.
      allow get: if request.auth.uid == userId || getUserRole() >= 1;

      // Admins can see the scoreboard.
      allow list: if request.query.limit <= 20 && getUserRole() >= 2;
    }
 
    // Referral codes.
    match /c/{code} {
      allow read: if resource.data.claimer == null || resource.data.bulk;
    }

    // Photo Uploads.
    match /u/{imageId} {
      // User can see their own uploaded photos.
      allow get: if request.auth.uid == resource.data.uploader.uid;

      // Moderator can see the uploaded photos.
      allow list: if request.query.limit <= 1 && getUserRole() >= 1;
    }

    // TPS change log.
    match /t/{tpsId} {
      // Only Moderator and above can see the TPS history.
      allow get: if getUserRole() >= 1;
    }
  }
}