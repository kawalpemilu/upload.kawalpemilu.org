<ng-container *ngIf="(state$ | async) as state; else loading">
  <app-path [node]="state"></app-path>

  <table
    cellspacing="0"
    cellpadding="0"
    width="100%"
    height="200"
    *ngFor="let tps of state.tpsList; let odd = odd"
    [style.background-color]="odd ? '#FFF' : '#EEE'"
  >
    <tr>
      <td align="center" width="125" valign="top">
        <div
          style="border: 1px solid black; width: 90px; padding: 5px; margin-top: 15px;"
        >
          TPS # <b style="font-size: large">{{ tps.tpsNo }}</b>
        </div>

        <p>
          <app-upload-sequence
            [kelId]="state.id"
            [kelName]="state.name"
            [tpsNo]="tps.tpsNo"
            [value]="'Upload Foto'"
          ></app-upload-sequence>
        </p>

        <div style="height: 135px; overflow-y: auto">
          <table
            border="1"
            width="115"
            *ngIf="tps.agg as d"
            cellspacing="0"
            align="center"
            [style.background-color]="
              d.sum.error ? '#FDD' : d.sum.pending ? '#FFD' : ''
            "
          >
            <thead *ngIf="hasPpwp(d.sum)">
              <tr>
                <th colspan="2">PPWP</th>
              </tr>

              <ng-container *ngFor="let k of Object.keys(PPWP_NAMES)">
                <tr *ngIf="d.sum[k] !== undefined">
                  <td class="label">{{ PPWP_NAMES[k] }}:</td>
                  <td class="angka">{{ d.sum[k] }}</td>
                </tr>
              </ng-container>
            </thead>

            <tbody *ngIf="hasDpr(d.sum)">
              <tr>
                <th colspan="2">DPR</th>
              </tr>
              <ng-container *ngFor="let k of Object.keys(DPR_NAMES)">
                <tr *ngIf="d.sum[k] !== undefined">
                  <td class="label">{{ DPR_NAMES[k] }}:</td>
                  <td class="angka">{{ d.sum[k] }}</td>
                </tr>
              </ng-container>
            </tbody>
          </table>
        </div>

        <p>
          <ng-container *ngIf="tps.data as d">
            <span *ngIf="d.url && d.sum.error" style="color: red">
              Kesalahan telah dilaporkan untuk TPS ini
            </span>
            <app-lapor-button
              *ngIf="d.url && !d.sum.error"
              [id]="state.id"
              [imageId]="d.imageId"
            ></app-lapor-button>
          </ng-container>
        </p>
      </td>
      <td style="padding: 10px">
        <ng-container *ngIf="tps.agg?.photos">
          <app-carousel [height]="230" [photos]="toCarousel(tps.agg.photos)"></app-carousel>
        </ng-container>
        <p *ngIf="tps.agg?.sum?.pending" style="color: orange">
          Ada foto yang masuk dan belum diproses.
          <br />
          <br />
          <button
            *ngIf="
              (userService.relawan$ | async)?.profile?.role >=
              USER_ROLE.MODERATOR
            "
            mat-raised-button
            color="warn"
            [routerLink]="['/a', state.id, tps.tpsNo, 0]"
          >
            Digitize
          </button>
        </p>
      </td>
    </tr>
  </table>
</ng-container>

<ng-template #loading>
  <p><mat-spinner></mat-spinner></p>
</ng-template>
