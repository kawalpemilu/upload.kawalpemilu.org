<ng-container *ngIf="(state$ | async) as state; else loading">
  <app-path [node]="state"></app-path>

  <ng-container *ngIf="slices.length > 1">
    <p><b>Pilih kisaran nomor TPS:</b></p>
    <p style="line-height: 50px; padding-top: 0px">
      <ng-container *ngFor="let s of slices">
        <button
          mat-raised-button
          color="primary"
          [disabled]="showingSlice == s"
          (click)="showingSlice = s"
          style="margin-right: 15px"
          [matBadge]="s.pending ? s.pending : ''"
          matBadgePosition="after"
          matBadgeColor="accent"
        >
          {{ s.tpsLo }} - {{ s.tpsHi - 1 }}
        </button>
      </ng-container>
    </p>
  </ng-container>

  <ng-container *ngIf="showingSlice">
    <table
      cellspacing="0"
      cellpadding="0"
      width="100%"
      height="200"
      *ngFor="let tps of getSlice(state.tpsList, showingSlice); let odd = odd"
      [style.background-color]="odd ? '#FFF' : '#EEE'"
    >
      <ng-template #digitize>
        <tr *ngIf="digitize[tps.tpsNo] === 'done'">
          <td colspan="2">
            <p><mat-spinner></mat-spinner></p>
          </td>
        </tr>
        <tr *ngIf="digitize[tps.tpsNo] !== 'done'">
          <td colspan="2">
            <app-approver
              [kelId]="state.id"
              [tpsNo]="tps.tpsNo"
              [(imageId)]="digitize[tps.tpsNo]"
              (completed)="digitize[tps.tpsNo] = ''"
            ></app-approver>

            <p style="padding: 0 10px">
              <button
                mat-raised-button
                color="primary"
                (click)="digitize[tps.tpsNo] = ''"
              >
                <mat-icon>arrow_back</mat-icon>
                Gak Jadi Digitize Deh
              </button>
            </p>
          </td>
        </tr>
      </ng-template>

      <ng-container *ngIf="!digitize[tps.tpsNo]; else digitize">
        <tr height="60">
          <td align="center" width="125" style="padding: 10px 0;">
            <div
              style="border: 1px solid black; width: 90px; padding: 5px"
              (click)="toggleDetails(state, tps.tpsNo)"
              [style.cursor]="state.isModerator ? 'pointer' : ''"
            >
              TPS # <b style="font-size: large">{{ tps.tpsNo }}</b>
            </div>
          </td>
          <td rowspan="3" style="padding: 10px">
            <ng-container *ngIf="details[tps.tpsNo] as details$; else fotopub">
              <ng-container *ngIf="(details$ | async) as detail; else loadTps">
                <app-carousel
                  [height]="425"
                  [photos]="detail"
                  (edited)="digitize[tps.tpsNo] = $event.imageId"
                ></app-carousel>
              </ng-container>
              <ng-template #loadTps>
                <div style="height: 425px">
                  <mat-spinner></mat-spinner>
                </div>
              </ng-template>
            </ng-container>
            <ng-template #fotopub>
              <ng-container *ngIf="tps.agg?.photos">
                <app-carousel
                  [height]="275"
                  [photos]="tps.items"
                  [lapor]="true"
                ></app-carousel>
              </ng-container>
            </ng-template>
            <p *ngIf="tps.agg?.sum?.pending" style="color: orange">
              Ada foto yang masuk dan belum diproses.
              <br />
              <br />
              <button
                *ngIf="state.isModerator"
                mat-raised-button
                color="warn"
                (click)="digitize[tps.tpsNo] = 'next'"
              >
                Digitize
              </button>
            </p>
          </td>
        </tr>

        <tr height="45">
          <td align="center" valign="top">
            <app-upload-sequence
              [kelId]="state.id"
              [kelName]="state.name"
              [tpsNo]="tps.tpsNo"
              [value]="'Upload Foto'"
            ></app-upload-sequence>
          </td>
        </tr>

        <tr height="100%">
          <td align="center">
            <div style="height: 100%; overflow-y: auto">
              <table
                border="1"
                width="115"
                *ngIf="tps.agg as d"
                cellspacing="0"
                [style.background-color]="
                  d.sum.error
                    ? '#FDD'
                    : d.sum.pending
                    ? '#FFD'
                    : d.sum.janggal
                    ? 'orange'
                    : ''
                "
              >
                <thead *ngIf="hasPpwp(d.sum)">
                  <tr>
                    <th colspan="2">PPWP</th>
                  </tr>

                  <ng-container *ngFor="let k of Object.keys(PPWP_NAMES)">
                    <tr *ngIf="d.sum[k] !== undefined">
                      <td class="label">{{ PPWP_NAMES[k] }}:</td>
                      <td class="angka">{{ d.sum[k] }}</td>
                    </tr>
                  </ng-container>
                </thead>

                <tbody *ngIf="hasDpr(d.sum)">
                  <tr>
                    <th colspan="2">DPR</th>
                  </tr>
                  <ng-container *ngFor="let k of Object.keys(DPR_NAMES)">
                    <tr *ngIf="d.sum[k] !== undefined">
                      <td class="label">{{ DPR_NAMES[k] }}:</td>
                      <td class="angka">{{ d.sum[k] }}</td>
                    </tr>
                  </ng-container>
                </tbody>
              </table>
            </div>
          </td>
        </tr>
      </ng-container>
    </table>
  </ng-container>
</ng-container>

<ng-template #loading>
  <p><mat-spinner></mat-spinner></p>
</ng-template>
