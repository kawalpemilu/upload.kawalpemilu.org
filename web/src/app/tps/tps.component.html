<div *ngIf="(state$ | async) as state; else loading" class="wrapper">
  <app-path [node]="state"></app-path>

  <button
    mat-raised-button
    color="warn"
    [routerLink]="['/d', state.id]"
    *ngIf="
      state.numPending > 0 &&
      (userService.userRelawan$ | async).profile.role >= USER_ROLE.MODERATOR
    "
  >
    Digitize {{ state.numPending }} uploads
  </button>

  <p></p>

  <table cellspacing="0">
    <tr [style.height.px]="40" style="background-color: lightgray">
      <th class="tps">TPS</th>
      <th class="foto">Tes Upload Foto</th>
    </tr>
    <tr
      *ngFor="let tps of state.tpsList; let odd = odd"
      [style.background-color]="odd ? '#FFF' : '#EEE'"
    >
      <th class="tps">
        <p>TPS #{{ tps.tpsNo }}</p>
        <table
          *ngIf="tps.data as d"
          border="1"
          style="margin: 0 auto"
          cellspacing="0"
          [style.backgroundColor]="
            d.sum.error ? '#FDD' : d.sum.pending ? '#FFD' : ''
          "
        >
          <tr>
            <td class="label">Pas1:</td>
            <td class="angka">{{ d.sum.paslon1 }}</td>
          </tr>
          <tr>
            <td>Pas2:</td>
            <td class="angka">{{ d.sum.paslon2 }}</td>
          </tr>
          <tr>
            <td>Sah:</td>
            <td class="angka">{{ d.sum.sah }}</td>
          </tr>
          <tr>
            <td>~Sah:</td>
            <td class="angka">{{ d.sum.tidakSah }}</td>
          </tr>
        </table>

        <p></p>
      </th>
      <td class="foto">
        <table cellpadding="0" cellspacing="0" width="100%">
          <tr>
            <td width="125">
              <ng-container
                *ngIf="tps.data?.url as servingUrl; else adapending"
              >
                <app-thumbnail [url]="servingUrl" [size]="125"></app-thumbnail>
              </ng-container>
              <ng-template #adapending>
                <div *ngIf="tps.data?.sum?.pending">
                  Ada foto yang masuk dan belum diproses.
                </div>
              </ng-template>
            </td>
            <td align="center">
              <p *ngIf="tps.data as d; else bisaupload">
                <ng-container *ngIf="d.url; else bisaupload">
                  <ng-container *ngIf="d.sum.error">
                    <span style="color: red"
                      >Kesalahan telah dilaporkan untuk TPS ini</span
                    >
                    <ng-container *ngTemplateOutlet="bisaupload"></ng-container>
                  </ng-container>
                  <app-lapor-button
                    *ngIf="!d.sum.error"
                    [id]="state.id"
                    [imageId]="d.imageId"
                  ></app-lapor-button>
                </ng-container>
              </p>
              <ng-template #bisaupload>
                <p>
                  <button
                    *ngIf="!uploadService.task"
                    mat-raised-button
                    [routerLink]="['/u', state.id, tps.tpsNo]"
                    color="primary"
                  >
                    Jaga TPS / Upload Foto
                  </button>
                </p>
              </ng-template>
            </td>
          </tr>
        </table>
      </td>
    </tr>
  </table>
</div>

<ng-template #loading>
  <div style="padding: 10px">
    <mat-spinner></mat-spinner>
  </div>
</ng-template>
