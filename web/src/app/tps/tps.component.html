<ng-container *ngIf="(state$ | async) as state; else loading">
  <app-path [node]="state"></app-path>

  <button
    mat-raised-button
    color="warn"
    [routerLink]="['/d', state.id]"
    *ngIf="
      state.numPending > 0 &&
      (userService.relawan$ | async).profile.role >= USER_ROLE.MODERATOR
    "
  >
    Digitize {{ state.numPending }} uploads
  </button>

  <p></p>

  <table cellspacing="0">
    <tr [style.height.px]="40" style="background-color: lightgray">
      <th class="tps">TPS</th>
      <th class="foto">Tes Upload Foto untuk menjaga TPS</th>
    </tr>
    <tr
      *ngFor="let tps of state.tpsList; let odd = odd"
      [style.background-color]="odd ? '#FFF' : '#EEE'"
    >
      <th class="tps">
        <p>TPS #{{ tps.tpsNo }}</p>
        <table
          *ngIf="tps.data as d"
          border="1"
          style="margin: 0 auto"
          cellspacing="0"
          [style.backgroundColor]="
            d.sum.error ? '#FDD' : d.sum.pending ? '#FFD' : ''
          "
        >
          <tr>
            <td class="label">Pas1:</td>
            <td class="angka">{{ d.sum.paslon1 }}</td>
          </tr>
          <tr>
            <td>Pas2:</td>
            <td class="angka">{{ d.sum.paslon2 }}</td>
          </tr>
          <tr>
            <td>Sah:</td>
            <td class="angka">{{ d.sum.sah }}</td>
          </tr>
          <tr>
            <td>~Sah:</td>
            <td class="angka">{{ d.sum.tidakSah }}</td>
          </tr>
        </table>

        <p></p>
      </th>
      <td class="foto">
        <table cellpadding="0" cellspacing="0" width="100%">
          <tr>
            <td width="125">
              <ng-container
                *ngIf="tps.data?.url as servingUrl; else adapending"
              >
                <app-thumbnail [url]="servingUrl" [size]="125"></app-thumbnail>
              </ng-container>
              <ng-template #adapending>
                <div *ngIf="tps.data?.sum?.pending">
                  Ada foto yang masuk dan belum diproses.
                </div>
              </ng-template>
            </td>
            <td align="center">
              <p *ngIf="tps.data as d">
                <span *ngIf="d.url && d.sum.error" style="color: red">
                  Kesalahan telah dilaporkan untuk TPS ini
                </span>
                <app-lapor-button
                  *ngIf="d.url && !d.sum.error"
                  [id]="state.id"
                  [imageId]="d.imageId"
                ></app-lapor-button>
              </p>
              <p>
                <app-upload-sequence
                  [kelId]="state.id"
                  [kelName]="state.name"
                  [tpsNo]="tps.tpsNo"
                  [value]="'Upload Foto untuk Jaga TPS'"
                ></app-upload-sequence>
              </p>
            </td>
          </tr>
        </table>
      </td>
    </tr>
  </table>
</ng-container>

<ng-template #loading>
  <mat-spinner></mat-spinner>
</ng-template>
