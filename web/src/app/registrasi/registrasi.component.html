<div style="padding: 0 10px">
  <ng-container *ngIf="(userService.userRelawan$ | async) as user; else login">
    <h2>Registrasi Relawan Terpercaya</h2>

    <p>
      Halo,

      {{ user.auth.displayName }} [<a
        style="color: blue; cursor: pointer;"
        (click)="userService.logout()"
        >Logout</a
      >]
    </p>

    <p style="font-weight: bold; color: red" *ngIf="error">{{ error }}</p>

    <ng-container *ngIf="user.depth === undefined; else terpercaya">
      <ng-container *ngIf="(code$ | async) as code; else butuhkode">
        <ng-container *ngIf="code.claimer">
          <p>Maaf, kode referral "{{ theCode }}" sudah tidak aktif.</p>
        </ng-container>
      </ng-container>

      <ng-template #butuhkode>
        <p>
          Untuk registrasi menjadi relawan terpercaya, mintalah URL kode
          referral yang masih aktif dari teman anda yang sudah menjadi relawan
          terpercaya.
        </p>
      </ng-template>
    </ng-container>

    <ng-template #terpercaya>
      <p>
        Selamat! Anda telah ditunjuk oleh
        <a href="{{ getScopedUrl(user.referrer) }}" target="_blank">{{
          user.referrer.name
        }}</a>
        sebagai relawan terpercaya level {{ user.depth }}.
      </p>

      <ng-container *ngIf="user.depth < MAX_TRUSTED_DEPTH">
        <p>
          Anda dapat mengundang teman Facebook anda untuk menjadi relawan
          terpercaya dengan membuat kode referral dibawah ini.
        </p>

        <p>
          <b style="color: red">Catatan</b>: nama depan teman anda harus sama
          percis dengan nama teman anda di Facebook. Anda hanya bisa mengundang
          maksimum <b></b>150 teman.
        </p>

        <form [formGroup]="formGroup">
          <mat-form-field style="width: 225px">
            <input
              matInput
              placeholder="Nama depan teman anda"
              formControlName="namaCtrl"
              type="text"
              required
            />
          </mat-form-field>
          &nbsp;
          <span *ngIf="getError('namaCtrl') as error" class="alert">
            {{ error }}
          </span>

          <button
            type="submit"
            [disabled]="formGroup.invalid || isLoading"
            mat-raised-button
            color="primary"
            (click)="createReferralCode(user.auth)"
          >
            Buat Kode Referral
          </button>
        </form>

        <ng-container *ngIf="getReferralCodes(user, false) as codes">
          <ng-container *ngIf="codes.length > 0">
            <p>
              Kirimkan URL kode referral dibawah ini ke teman anda (satu kode
              referral hanya bisa dipakai oleh satu orang):
            </p>

            <table border="1" cellspacing="0">
              <tr bgcolor="lightgray">
                <th width="30">#</th>
                <td><b>Nama Depan</b></td>
                <td><b>URL kode referral untuk dibagikan</b></td>
              </tr>
              <tr
                *ngFor="let code of codes; let odd = odd; let i = index"
                [style.background-color]="odd ? '#FFF' : '#EEE'"
              >
                <td align="center">{{ i + 1 }}</td>
                <td>{{ user.code[code].name }}</td>
                <td style="padding: 7px">
                  <input
                    type="text"
                    style="width: 300px"
                    value="https://kawal-c1.firebaseapp.com/c/{{ code }}"
                    #ui
                  />
                  &nbsp;
                  <button
                    mat-raised-button
                    color="primary"
                    (click)="copyCode(ui)"
                  >
                    <mat-icon>file_copy</mat-icon> Copy
                  </button>
                </td>
              </tr>
            </table>
          </ng-container>
        </ng-container>

        <ng-container *ngIf="getReferralCodes(user, true) as codes">
          <ng-container *ngIf="codes.length > 0">
            <p>
              Berikut ini adalah teman-teman ada yang sudah menerima undangan
              anda dan telah menjadi relawan terpercaya:
            </p>

            <table border="1" cellpadding="0" cellspacing="0">
              <tr bgcolor="lightgray">
                <td><b>Nama</b></td>
                <td><b>Profile teman anda</b></td>
              </tr>
              <tr
                *ngFor="let code of codes; let odd = odd"
                [style.background-color]="odd ? '#FFF' : '#EEE'"
              >
                <td>{{ user.code[code].name }}</td>
                <td>
                  <a
                    href="{{ getScopedUrl(user.code[code].claimer) }}"
                    target="_blank"
                    >{{ user.code[code].claimer.name }}</a
                  >
                </td>
              </tr>
            </table>
          </ng-container>
        </ng-container>
      </ng-container>
    </ng-template>
  </ng-container>

  <ng-template #login>
    <app-login fitur="registrasi relawan terpercaya"></app-login>
  </ng-template>
</div>

<br /><br /><br /><br /><br />
